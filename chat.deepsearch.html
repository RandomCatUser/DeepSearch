<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DeepSearch : Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { mono: ['JetBrains Mono', 'monospace'] },
          boxShadow: {
            glow: '0 0 0 1px rgba(255,255,255,0.06), 0 8px 30px rgba(0,0,0,0.35)'
          },
          colors: {
            brand: {
              50: '#EFF6FF', 100: '#DBEAFE', 200: '#BFDBFE', 300: '#93C5FD',
              400: '#60A5FA', 500: '#3B82F6', 600: '#2563EB', 700: '#1D4ED8', 800: '#1E40AF', 900: '#1E3A8A'
            }
          }
        }
      }
    }
  </script>
  <style>
    :root { color-scheme: dark; }
    body { background: radial-gradient(1200px 600px at 10% -10%, rgba(59,130,246,.18), transparent),
                    radial-gradient(800px 600px at 90% 10%, rgba(16,185,129,.12), transparent),
                    #0b1020; }
    .glass { backdrop-filter: blur(14px) saturate(140%); background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); }
    .btn { @apply px-4 py-2 rounded-2xl font-semibold hover:opacity-90 transition; }
    .btn-primary { @apply bg-brand-600 text-white; }
    .btn-ghost { @apply bg-white/5 text-white; }
    .kbd { @apply px-2 py-1 rounded-md bg-white/10 border border-white/20 text-xs; }
  </style>
</head>
<body class="font-mono text-white/90">
  <header class="sticky top-0 z-50">
    <div class="glass shadow-glow">
      <div class="max-w-6xl mx-auto flex items-center gap-4 p-3">
        <div class="text-xl font-bold tracking-tight">DeepSearch</div>
        <div class="hidden md:flex items-center gap-2 text-xs text-white/70">
          <span class="kbd">/</span><span>focus</span>
          <span class="kbd">Enter</span><span>run</span>
        </div>
        <div class="ml-auto flex items-center gap-2 text-sm">
          <button id="helpBtn" class="btn btn-ghost">Help</button>
          <a href="https://text.pollinations.ai/models" target="_blank" class="btn btn-ghost">Text Models</a>
          <a href="https://image.pollinations.ai/models" target="_blank" class="btn btn-ghost">Image Models</a>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-2 sm:px-4 pb-28">
    <!-- Search Bar -->
    <section class="mt-6 sm:mt-10">
      <div class="glass rounded-2xl sm:rounded-3xl shadow-glow p-3 sm:p-4 md:p-6">
        <form id="searchForm" class="flex flex-col md:flex-row gap-2 sm:gap-3 items-stretch md:items-center">
          <div class="relative flex-1">
            <input id="query" type="text" placeholder="Ask anything… (e.g., 'What is quantum tunneling?')" class="w-full bg-transparent outline-none rounded-xl sm:rounded-2xl border border-white/20 px-3 sm:px-4 py-2 sm:py-3 pr-24 sm:pr-28 text-sm sm:text-base" required />
            <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1 sm:gap-2">
              <select id="mode" class="bg-white/10 border border-white/20 rounded-lg sm:rounded-xl px-1 sm:px-2 py-0.5 sm:py-1 text-xs sm:text-sm">
                <option value="answer">Answer</option>
                <option value="images">Images</option>
                
              </select>
              <button class="btn btn-primary text-xs sm:text-sm" type="submit">Search</button>
            </div>
          </div>
        </form>
        <div class="mt-2 sm:mt-3 text-xs text-white/60 flex flex-wrap gap-2 sm:gap-3">
          <span>Requests left this hour: <b id="quotaLeft">10</b> / 10</span>
          <span class="hidden sm:inline">•</span>
          <span>Model: <select id="textModel" class="bg-white/10 border border-white/20 rounded-md px-1 sm:px-2 py-0.5"></select></span>
          <span>Image Model: <select id="imageModel" class="bg-white/10 border border-white/20 rounded-md px-1 sm:px-2 py-0.5"></select></span>
          
          </select></span>
        </div>
      </div>
    </section>

    <!-- Content Grid -->
    <section class="mt-4 sm:mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
      <!-- Answer / Images / Audio Output -->
      <div class="lg:col-span-2 glass rounded-2xl sm:rounded-3xl shadow-glow p-3 sm:p-5 min-h-[220px] sm:min-h-[320px]">
        <div id="result" class="prose prose-invert max-w-none text-sm sm:text-base">
          <p class="text-white/70">Results will appear here. Try a query, then switch modes (Answer / Images / Audio).</p>
        </div>
      </div>

      <!-- Live Feeds -->
      <aside class="glass rounded-2xl sm:rounded-3xl shadow-glow p-3 sm:p-5">
        <h3 class="font-bold mb-2 sm:mb-3 text-base sm:text-lg">Live Feeds</h3>
        <div class="space-y-2 sm:space-y-4">
          <div>
            <div class="text-xs sm:text-sm font-semibold mb-1">Text Feed</div>
            <div id="textFeed" class="text-xs max-h-32 sm:max-h-44 overflow-auto space-y-1 sm:space-y-2"></div>
          </div>
          <div>
            <div class="text-xs sm:text-sm font-semibold mb-1">Image Feed</div>
            <div id="imageFeed" class="grid grid-cols-2 sm:grid-cols-3 gap-1 sm:gap-2 max-h-32 sm:max-h-44 overflow-auto"></div>
          </div>
        </div>
      </aside>
    </section>

    <!-- Gallery (for Images mode) -->
    <section id="gallerySection" class="hidden mt-4 sm:mt-6 glass rounded-2xl sm:rounded-3xl shadow-glow p-3 sm:p-5">
      <h3 class="font-bold mb-2 sm:mb-3 text-base sm:text-lg">Image Results</h3>
      <div id="gallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3"></div>
    </section>
  </main>

  <template id="feedTextItem">
    <div class="p-2 bg-white/5 rounded-xl border border-white/10"></div>
  </template>

  <template id="imageCardTpl">
    <a class="block group" target="_blank" rel="noreferrer">
      <img class="w-full h-44 object-cover rounded-xl border border-white/10 group-hover:opacity-90 transition" />
      <div class="mt-1 text-xs text-white/60 line-clamp-2"></div>
    </a>
  </template>

  <dialog id="helpDlg" class="glass rounded-3xl p-0 border-none w-[680px] max-w-[96vw]">
    <div class="p-6 space-y-4">
      <h2 class="text-xl font-bold">How it works</h2>
      <ol class="list-decimal pl-5 space-y-1 text-sm text-white/80">
        <li>Type your query. Choose a mode: <b>Answer</b> (text generation), <b>Images</b> (image generation), or <b>Audio</b> (TTS).
        </li>
        <li>Pick your preferred <b>model</b> from the dropdowns (auto‑loaded from Pollinations <code>/models</code> endpoints).
        </li>
        <li>We enforce a local rate‑limit: <b>10 requests/hour</b> stored in <code>localStorage</code>.</li>
      </ol>
      <div class="text-xs text-white/60">Endpoints used:
        <ul class="list-disc pl-5">
          <li><code>GET https://text.pollinations.ai/{prompt}?model=&lt;model&gt;</code></li>
          <li><code>GET https://image.pollinations.ai/prompt/{prompt}?model=&lt;model&gt;</code></li>
          <li><code>GET https://text.pollinations.ai/{prompt}?model=openai-audio&voice=&lt;voice&gt;</code></li>
          <li><code>GET https://text.pollinations.ai/feed</code>, <code>GET https://image.pollinations.ai/feed</code></li>
        </ul>
      </div>
      <div class="flex justify-end gap-2"><button id="closeHelp" class="btn btn-primary">Close</button></div>
    </div>
  </dialog>

  <script>
    const els = {
      form: document.getElementById('searchForm'),
      query: document.getElementById('query'),
      mode: document.getElementById('mode'),
      result: document.getElementById('result'),
      textModel: document.getElementById('textModel'),
      imageModel: document.getElementById('imageModel'),
      voice: document.getElementById('voice'),
      quotaLeft: document.getElementById('quotaLeft'),
      gallery: document.getElementById('gallery'),
      gallerySection: document.getElementById('gallerySection'),
      textFeed: document.getElementById('textFeed'),
      imageFeed: document.getElementById('imageFeed'),
      helpBtn: document.getElementById('helpBtn'),
      helpDlg: document.getElementById('helpDlg'),
      closeHelp: document.getElementById('closeHelp'),
    };

    // --- Local Rate Limit (10/hour) ---
    const LIMIT = 10;
    function loadQuota(){
      const sliceStart = Math.floor(Date.now()/3600000)*3600000; // hour bucket
      const key = 'quota:'+sliceStart;
      const used = Number(localStorage.getItem(key) || 0);
      els.quotaLeft.textContent = Math.max(0, LIMIT - used);
      return { key, used };
    }
    function incQuota(key, used){
      localStorage.setItem(key, used+1);
      els.quotaLeft.textContent = Math.max(0, LIMIT - (used+1));
    }

    // --- Helpers ---
    function mdToHtml(md){
      // very light markdown to html (bold, code, links, breaks)
      return md
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
        .replace(/`([^`]+)`/g,'<code>$1</code>')
        .replace(/\[(.*?)\]\((.*?)\)/g,'<a class="underline" href="$2" target="_blank" rel="noreferrer">$1<\/a>')
        .replace(/\n/g,'<br/>');
    }

    async function fetchTextModels(){
      try {
        const res = await fetch('https://text.pollinations.ai/models');
        const models = await res.json();
        els.textModel.innerHTML = '';
        models.forEach(m=>{
          const o = document.createElement('option');
          o.value = m.name || m.id || m;
          o.textContent = m.name || m.id || m;
          if(o.value === 'deepseek-r1:free') o.selected = true; // Default to deepseek-r1:free
          els.textModel.appendChild(o);
        });
        // If not found, add manually
        if(!Array.from(els.textModel.options).some(opt => opt.value === 'deepseek-r1:free')) {
          const o = document.createElement('option');
          o.value = 'qwen-coder';
          o.textContent = 'qwen-coder';
          o.selected = true;
          els.textModel.appendChild(o);
        }
      } catch(e){
        els.textModel.innerHTML = '<option selected>deepseek-r1:free</option>';
      }
    }

    async function fetchImageModels(){
      try {
        const res = await fetch('https://image.pollinations.ai/models');
        const models = await res.json();
        els.imageModel.innerHTML = '';
        models.forEach(m=>{
          const o = document.createElement('option');
          o.value = m.name || m.id || m;
          o.textContent = m.name || m.id || m;
          els.imageModel.appendChild(o);
        });
      } catch(e){
        els.imageModel.innerHTML = '<option>flux</option><option>sdxl</option>';
      }
    }

    // --- Execute Query ---
    async function handleSearch(evt){
      evt.preventDefault();
      const { key, used } = loadQuota();
      if(used >= LIMIT){
        els.result.innerHTML = '<p class="text-red-300">Hourly limit reached (10). Try again next hour.</p>';
        return;
      }
      const q = els.query.value.trim();
      if(!q) return;

      if(els.mode.value === 'answer'){
        await runAnswer(q, els.textModel.value, key, used);
      } else if(els.mode.value === 'images'){
        await runImages(q, els.imageModel.value, key, used);
      } else {
        await runAudio(q, els.voice.value, key, used);
      }
    }

    async function runAnswer(q, model, key, used){
      els.gallerySection.classList.add('hidden');
      els.result.innerHTML = '<div class="animate-pulse text-white/60">Thinking…</div>';
      try {
        const url = `https://text.pollinations.ai/${encodeURIComponent(q)}?model=${encodeURIComponent(model)}`;
        const res = await fetch(url);
        const text = await res.text();
        els.result.innerHTML = `<article class='leading-7'>${mdToHtml(text)}</article>`;
        incQuota(key, used);
      } catch (e) {
        console.error(e);
        els.result.innerHTML = '<p class="text-red-300">Failed to fetch answer.</p>';
      }
    }

    async function runImages(q, model, key, used){
      els.result.innerHTML = '<div class="text-white/70">Generating images…</div>';
      els.gallery.innerHTML = '';
      els.gallerySection.classList.remove('hidden');
      const n = 8; // number of thumbs
      try {
        const items = Array.from({length:n}).map((_,i)=>{
          const seed = Date.now()+i;
          const src = `https://image.pollinations.ai/prompt/${encodeURIComponent(q)}?model=${encodeURIComponent(model)}&seed=${seed}`;
          return { src, prompt: q };
        });
        items.forEach(({src,prompt})=>{
          const tpl = document.getElementById('imageCardTpl').content.cloneNode(true);
          const a = tpl.querySelector('a');
          const img = tpl.querySelector('img');
          const cap = tpl.querySelector('div');
          a.href = src; img.src = src; cap.textContent = prompt;
          els.gallery.appendChild(tpl);
        });
        els.result.innerHTML = '<p class="text-white/70">Scroll for generated images. Click any image to open full size.</p>';
        incQuota(key, used);
      } catch(e){
        console.error(e);
        els.result.innerHTML = '<p class="text-red-300">Failed to generate images.</p>';
      }
    }

    async function runAudio(q, voice, key, used){
      els.gallerySection.classList.add('hidden');
      els.result.innerHTML = '<div class="text-white/70">Generating audio…</div>';
      try {
        const url = `https://text.pollinations.ai/${encodeURIComponent(q)}?model=openai-audio&voice=${encodeURIComponent(voice)}`;
        const res = await fetch(url);
        const text = await res.text();
        // The endpoint returns text or an audio URL depending on backend; support both cases
        let audioUrl = '';
        if(/^https?:\/\//i.test(text.trim())) { audioUrl = text.trim(); }
        else {
          // If we actually got a transcript, synthesize via <audio> using a data URL fetch if possible (best effort fallback)
          // Here we assume the API returned a URL-less body; we just speak it with SpeechSynthesis as a fallback.
          const p = new SpeechSynthesisUtterance(text);
          speechSynthesis.speak(p);
          els.result.innerHTML = `<p class='text-white/70'>Playing via browser TTS. Text:<br><span class='text-white/90'>${mdToHtml(text)}</span></p>`;
          incQuota(key, used);
          return;
        }
        const audio = document.createElement('audio');
        audio.controls = true; audio.src = audioUrl; audio.autoplay = true;
        els.result.innerHTML = '';
        els.result.appendChild(audio);
        incQuota(key, used);
      } catch(e){
        console.error(e);
        els.result.innerHTML = '<p class="text-red-300">Failed to generate audio.</p>';
      }
    }

    // --- Live Feeds ---
    async function loadFeeds(){
      try {
        const [tf, ifd] = await Promise.all([
          fetch('https://text.pollinations.ai/feed').then(r=>r.json()).catch(()=>[]),
          fetch('https://image.pollinations.ai/feed').then(r=>r.json()).catch(()=>[]),
        ]);
        // text feed
        els.textFeed.innerHTML = '';
        (tf || []).slice(0,20).forEach(item=>{
          const n = document.getElementById('feedTextItem').content.cloneNode(true);
          n.querySelector('div').textContent = (item?.prompt || item?.text || JSON.stringify(item)).slice(0,180);
          els.textFeed.appendChild(n);
        });
        // image feed
        els.imageFeed.innerHTML = '';
        (ifd || []).slice(0,12).forEach(item=>{
          const img = document.createElement('img');
          img.loading = 'lazy';
          img.referrerPolicy = 'no-referrer';
          img.className = 'w-full h-20 object-cover rounded-xl border border-white/10';
          const src = item?.url || item?.image || item?.link || item?.src;
          if(src) img.src = src; else return;
          els.imageFeed.appendChild(img);
        });
      } catch(e){ console.warn('feed error', e); }
    }

    // --- UI wiring ---
    els.form.addEventListener('submit', handleSearch);
    document.addEventListener('keydown', (e)=>{ if(e.key === '/' && document.activeElement !== els.query){ e.preventDefault(); els.query.focus(); } });
    els.helpBtn.addEventListener('click', ()=> els.helpDlg.showModal());
    els.closeHelp.addEventListener('click', ()=> els.helpDlg.close());

    // init
    loadQuota();
    fetchTextModels();
    fetchImageModels();
    loadFeeds();
    setInterval(loadQuota, 10_000);
    setInterval(loadFeeds, 30_000);
  </script>
</body>
</html>
